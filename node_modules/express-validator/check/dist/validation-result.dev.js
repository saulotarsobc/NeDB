"use strict";

var _ = require('lodash');

module.exports = withDefaults();
module.exports.withDefaults = withDefaults;

function withDefaults() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var defaults = {
    formatter: function formatter(error) {
      return error;
    }
  };

  _.defaults(options, defaults);

  function decorateAsValidationResult(obj) {
    var errors = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
    var formatter = options.formatter;

    obj.isEmpty = function () {
      return !errors.length;
    };

    obj.array = function () {
      var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
          onlyFirstError = _ref.onlyFirstError;

      var used = {};
      var filteredErrors = !onlyFirstError ? errors : errors.filter(function (error) {
        if (used[error.param]) {
          return false;
        }

        used[error.param] = true;
        return true;
      });
      return filteredErrors.map(formatter);
    };

    obj.mapped = function () {
      return errors.reduce(function (mapping, error) {
        if (!mapping[error.param]) {
          mapping[error.param] = formatter(error);
        }

        return mapping;
      }, {});
    };

    obj.formatWith = function (errorFormatter) {
      formatter = errorFormatter;
      return obj;
    };

    obj["throw"] = function () {
      if (errors.length) {
        throw decorateAsValidationResult(new Error('Validation failed'), errors).formatWith(formatter);
      }
    };

    return obj;
  }

  return function (req) {
    return decorateAsValidationResult({}, req._validationErrors);
  };
}